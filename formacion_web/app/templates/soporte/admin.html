{% extends "base.html" %}

{% block title %}Е Panel de Soporte{% endblock %}

{% block content %}
<div class="relative min-h-[70vh]">
    <!-- Fondo con textura de tela sutil -->
    <div class="absolute inset-0 opacity-3" style="background-image: radial-gradient(circle, rgba(139, 69, 19, 0.1) 1px, transparent 1px); background-size: 30px 30px;"></div>
    
    <div class="relative z-10 bg-parchment/95 backdrop-blur-sm rounded-xl overflow-hidden parchment-shadow border-2 border-ink/20">
        
        <!-- Header con estilo de los Elfos Dom茅sticos -->
        <div class="bg-gradient-to-r from-slytherin/15 via-parchment to-slytherin/15 px-6 py-5 border-b border-ink/20">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <div class="absolute inset-0 bg-slytherin rounded-full blur-md opacity-20"></div>
                        <div class="relative w-12 h-12 bg-gradient-to-br from-slytherin to-amber-800 rounded-xl flex items-center justify-center border-2 border-parchment shadow-md">
                            <span class="text-2xl">Е</span>
                        </div>
                    </div>
                    <div>
                        <h1 class="font-heading font-bold text-xl text-ink tracking-tight">Panel de Soporte</h1>
                        <p class="font-body text-sm text-ink/70 mt-1">Gesti贸n de solicitudes de alumnos y profesores</p>
                    </div>
                </div>
                
                <!-- Estad铆sticas r谩pidas -->
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <div class="font-body font-bold text-lg text-slytherin">{{ mensajes_pendientes|length }}</div>
                        <div class="font-body text-xs text-ink/60">Pendientes</div>
                    </div>
                    <div class="w-px h-6 bg-ink/20"></div>
                    <div class="text-right">
                        <div class="font-body font-bold text-lg text-green-600">{{ mensajes_resueltos|length }}</div>
                        <div class="font-body text-xs text-ink/60">Resueltos</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="px-6 py-8">
            <!-- Secci贸n: Mensajes de Alumnos -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-5 pb-4 border-b border-ink/20">
                    <h2 class="font-heading font-bold text-lg text-ink flex items-center gap-2">
                        <span class="material-symbols-outlined text-slytherin text-xl">school</span>
                        Mensajes de Alumnos
                    </h2>
                    <span class="inline-flex items-center gap-1.5 px-3 py-1 bg-slytherin/10 border border-slytherin/30 text-slytherin font-body font-bold text-xs rounded-full">
                        <span class="material-symbols-outlined text-[14px]">groups</span>
                        {{ mensajes_alumnos|length }} solicitudes
                    </span>
                </div>
                
                {% if mensajes_alumnos %}
                    <div class="space-y-4">
                        {% for msg in mensajes_alumnos %}
                            <div class="bg-parchment border-2 {{ 'border-green-500/50' if msg.resuelto else ('border-red-500/30' if not msg.leido else 'border-slytherin/20') }} rounded-xl p-5 hover:shadow-md transition-shadow">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex items-start gap-3 flex-1">
                                        <div class="w-10 h-10 rounded-full bg-slytherin/15 flex items-center justify-center flex-shrink-0 mt-1 border border-slytherin/30">
                                            <span class="text-xl">Е</span>
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <div class="flex items-center justify-between">
                                                <strong class="font-body font-medium text-ink flex items-center gap-1.5">
                                                    <span class="material-symbols-outlined text-[16px] text-slytherin">person</span>
                                                    {{ msg.remitente_username }}
                                                    {% if msg.remitente_role == 'desconocido' %}
                                                        <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-amber-100 border border-amber-300 text-amber-700 font-body text-[10px] rounded-full">
                                                            <span class="material-symbols-outlined text-[12px]">help</span>
                                                            Desconocido
                                                        </span>
                                                    {% endif %}
                                                </strong>
                                                <small class="font-body text-xs text-ink/60">{{ msg.fecha.strftime('%d/%m/%Y %H:%M') }}</small>
                                            </div>
                                            <p class="font-body text-ink mt-2 leading-relaxed">{{ msg.mensaje }}</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Badge de estado -->
                                    <div class="ml-4 flex-shrink-0">
                                        {% if msg.resuelto %}
                                            <span class="inline-flex items-center gap-1.5 px-3 py-1 bg-green-100 border border-green-300 text-green-700 font-body font-bold text-xs rounded-full">
                                                <span class="material-symbols-outlined text-[14px]">check_circle</span>
                                                Resuelto
                                            </span>
                                        {% elif not msg.leido %}
                                            <span class="inline-flex items-center gap-1.5 px-3 py-1 bg-red-100 border border-red-300 text-red-700 font-body font-bold text-xs rounded-full animate-pulse">
                                                <span class="material-symbols-outlined text-[14px]">priority_high</span>
                                                Urgente
                                            </span>
                                        {% else %}
                                            <span class="inline-flex items-center gap-1.5 px-3 py-1 bg-slytherin/10 border border-slytherin/30 text-slytherin font-body font-bold text-xs rounded-full">
                                                <span class="material-symbols-outlined text-[14px]">schedule</span>
                                                Pendiente
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Respuesta si existe -->
                                {% if msg.respuesta %}
                                    <div class="mt-4 bg-slytherin/5 border border-slytherin/20 rounded-xl p-4">
                                        <div class="flex items-start gap-3">
                                            <div class="w-9 h-9 rounded-full bg-ravenclaw/15 flex items-center justify-center flex-shrink-0 mt-1 border border-ravenclaw/30">
                                                <span class="material-symbols-outlined text-ravenclaw text-lg">admin_panel_settings</span>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center justify-between">
                                                    <strong class="font-body font-medium text-ravenclaw flex items-center gap-1.5">
                                                        <span class="material-symbols-outlined text-[16px]">check_circle</span>
                                                        Respondido por admin
                                                    </strong>
                                                    <small class="font-body text-xs text-ink/60">{{ msg.fecha_respuesta.strftime('%d/%m/%Y %H:%M') }}</small>
                                                </div>
                                                <p class="font-body text-ink mt-2 leading-relaxed">{{ msg.respuesta }}</p>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <!-- Formulario de respuesta -->
                                    <form method="post" action="{{ url_for('soporte.responder', id=msg.id) }}" class="mt-4">
                                        <div class="flex items-center gap-3">
                                            <input type="text" name="respuesta" placeholder="Escribe tu respuesta..." required class="flex-1 bg-parchment border-2 border-ink/20 rounded-lg font-body text-sm text-ink px-4 py-2.5 focus:border-slytherin focus:ring-1 focus:ring-slytherin/30 focus:ring-offset-0 transition-colors">
                                            <button type="submit" class="px-4 py-2.5 bg-gradient-to-r from-slytherin to-slytherin/80 hover:from-slytherin/90 hover:to-slytherin/70 text-parchment font-body font-bold text-sm rounded-lg shadow-sm hover:shadow-md transition-all duration-300 border border-slytherin/30 hover:border-slytherin flex items-center gap-1.5">
                                                <span class="material-symbols-outlined text-base">send</span>
                                                Responder
                                            </button>
                                        </div>
                                    </form>
                                {% endif %}
                                
                                <!-- Botones de acci贸n -->
                                <div class="mt-4 flex items-center gap-2">
                                    {% if msg.respuesta and not msg.resuelto %}
                                        <form method="post" action="{{ url_for('soporte.resolver_mensaje', id=msg.id) }}" class="inline">
                                            <button type="submit" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white font-body font-bold text-xs rounded-lg shadow-sm hover:shadow transition-colors flex items-center gap-1.5 border border-green-700">
                                                <span class="material-symbols-outlined text-[14px]">check_circle</span>
                                                Marcar resuelto
                                            </button>
                                        </form>
                                    {% endif %}
                                    
                                    {% if msg.resuelto %}
                                        <form method="post" action="{{ url_for('soporte.eliminar_mensaje', id=msg.id) }}" class="inline" onsubmit="return confirm('驴Eliminar mensaje resuelto?');">
                                            <button type="submit" class="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white font-body font-bold text-xs rounded-lg shadow-sm hover:shadow transition-colors flex items-center gap-1.5 border border-red-700">
                                                <span class="material-symbols-outlined text-[14px]">delete</span>
                                                Eliminar
                                            </button>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-12 text-ink/60 font-body">
                        <span class="material-symbols-outlined text-4xl mb-3 block text-slytherin/30">school</span>
                        No hay mensajes de alumnos pendientes
                    </div>
                {% endif %}
            </div>

            <!-- Secci贸n: Mensajes de Profesores -->
            <div>
                <div class="flex items-center justify-between mb-5 pb-4 border-b border-ink/20">
                    <h2 class="font-heading font-bold text-lg text-ink flex items-center gap-2">
                        <span class="material-symbols-outlined text-ravenclaw text-xl">menu_book</span>
                        Mensajes de Profesores
                    </h2>
                    <span class="inline-flex items-center gap-1.5 px-3 py-1 bg-ravenclaw/10 border border-ravenclaw/30 text-ravenclaw font-body font-bold text-xs rounded-full">
                        <span class="material-symbols-outlined text-[14px]">groups</span>
                        {{ mensajes_profesores|length }} solicitudes
                    </span>
                </div>
                
                {% if mensajes_profesores %}
                    <div class="space-y-4">
                        {% for msg in mensajes_profesores %}
                            <div class="bg-parchment border-2 {{ 'border-green-500/50' if msg.resuelto else ('border-red-500/30' if not msg.leido else 'border-ravenclaw/20') }} rounded-xl p-5 hover:shadow-md transition-shadow">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex items-start gap-3 flex-1">
                                        <div class="w-10 h-10 rounded-full bg-ravenclaw/15 flex items-center justify-center flex-shrink-0 mt-1 border border-ravenclaw/30">
                                            <span class="material-symbols-outlined text-ravenclaw text-lg">school</span>
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <div class="flex items-center justify-between">
                                                <strong class="font-body font-medium text-ink flex items-center gap-1.5">
                                                    <span class="material-symbols-outlined text-[16px] text-ravenclaw">person</span>
                                                    {{ msg.remitente_username }}
                                                </strong>
                                                <small class="font-body text-xs text-ink/60">{{ msg.fecha.strftime('%d/%m/%Y %H:%M') }}</small>
                                            </div>
                                            <p class="font-body text-ink mt-2 leading-relaxed">{{ msg.mensaje }}</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Badge de estado -->
                                    <div class="ml-4 flex-shrink-0">
                                        {% if msg.resuelto %}
                                            <span class="inline-flex items-center gap-1.5 px-3 py-1 bg-green-100 border border-green-300 text-green-700 font-body font-bold text-xs rounded-full">
                                                <span class="material-symbols-outlined text-[14px]">check_circle</span>
                                                Resuelto
                                            </span>
                                        {% elif not msg.leido %}
                                            <span class="inline-flex items-center gap-1.5 px-3 py-1 bg-red-100 border border-red-300 text-red-700 font-body font-bold text-xs rounded-full animate-pulse">
                                                <span class="material-symbols-outlined text-[14px]">priority_high</span>
                                                Urgente
                                            </span>
                                        {% else %}
                                            <span class="inline-flex items-center gap-1.5 px-3 py-1 bg-ravenclaw/10 border border-ravenclaw/30 text-ravenclaw font-body font-bold text-xs rounded-full">
                                                <span class="material-symbols-outlined text-[14px]">schedule</span>
                                                Pendiente
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Respuesta si existe -->
                                {% if msg.respuesta %}
                                    <div class="mt-4 bg-ravenclaw/5 border border-ravenclaw/20 rounded-xl p-4">
                                        <div class="flex items-start gap-3">
                                            <div class="w-9 h-9 rounded-full bg-ravenclaw/15 flex items-center justify-center flex-shrink-0 mt-1 border border-ravenclaw/30">
                                                <span class="material-symbols-outlined text-ravenclaw text-lg">admin_panel_settings</span>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center justify-between">
                                                    <strong class="font-body font-medium text-ravenclaw flex items-center gap-1.5">
                                                        <span class="material-symbols-outlined text-[16px]">check_circle</span>
                                                        Respondido por admin
                                                    </strong>
                                                    <small class="font-body text-xs text-ink/60">{{ msg.fecha_respuesta.strftime('%d/%m/%Y %H:%M') }}</small>
                                                </div>
                                                <p class="font-body text-ink mt-2 leading-relaxed">{{ msg.respuesta }}</p>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <!-- Formulario de respuesta -->
                                    <form method="post" action="{{ url_for('soporte.responder', id=msg.id) }}" class="mt-4">
                                        <div class="flex items-center gap-3">
                                            <input type="text" name="respuesta" placeholder="Escribe tu respuesta..." required class="flex-1 bg-parchment border-2 border-ink/20 rounded-lg font-body text-sm text-ink px-4 py-2.5 focus:border-ravenclaw focus:ring-1 focus:ring-ravenclaw/30 focus:ring-offset-0 transition-colors">
                                            <button type="submit" class="px-4 py-2.5 bg-gradient-to-r from-ravenclaw to-ravenclaw/80 hover:from-ravenclaw/90 hover:to-ravenclaw/70 text-parchment font-body font-bold text-sm rounded-lg shadow-sm hover:shadow-md transition-all duration-300 border border-ravenclaw/30 hover:border-ravenclaw flex items-center gap-1.5">
                                                <span class="material-symbols-outlined text-base">send</span>
                                                Responder
                                            </button>
                                        </div>
                                    </form>
                                {% endif %}
                                
                                <!-- Botones de acci贸n -->
                                <div class="mt-4 flex items-center gap-2">
                                    {% if msg.respuesta and not msg.resuelto %}
                                        <form method="post" action="{{ url_for('soporte.resolver_mensaje', id=msg.id) }}" class="inline">
                                            <button type="submit" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white font-body font-bold text-xs rounded-lg shadow-sm hover:shadow transition-colors flex items-center gap-1.5 border border-green-700">
                                                <span class="material-symbols-outlined text-[14px]">check_circle</span>
                                                Marcar resuelto
                                            </button>
                                        </form>
                                    {% endif %}
                                    
                                    {% if msg.resuelto %}
                                        <form method="post" action="{{ url_for('soporte.eliminar_mensaje', id=msg.id) }}" class="inline" onsubmit="return confirm('驴Eliminar mensaje resuelto?');">
                                            <button type="submit" class="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white font-body font-bold text-xs rounded-lg shadow-sm hover:shadow transition-colors flex items-center gap-1.5 border border-red-700">
                                                <span class="material-symbols-outlined text-[14px]">delete</span>
                                                Eliminar
                                            </button>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-12 text-ink/60 font-body">
                        <span class="material-symbols-outlined text-4xl mb-3 block text-ravenclaw/30">menu_book</span>
                        No hay mensajes de profesores pendientes
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    /* Animaci贸n de pulso */
    @keyframes pulse {
        0%, 100% { opacity: 0.6; }
        50% { opacity: 1; }
    }
    
    .animate-pulse {
        animation: pulse 2s infinite;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .px-6 {
            padding-left: 1.25rem !important;
            padding-right: 1.25rem !important;
        }
        
        .py-8 {
            padding-top: 1.5rem !important;
            padding-bottom: 1.5rem !important;
        }
        
        input[type="text"] {
            width: 100% !important;
        }
        
        .flex.items-center.gap-3 > button {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}